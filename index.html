<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>اختبار رسومات العلوم المطور</title>
  
  <!-- Google Fonts - Cairo -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary-color: #007BFF;
      --primary-hover: #0056b3;
      --secondary-color: #f4f4f9;
      --light-color: #ffffff;
      --dark-color: #333;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --light-green: #e9f7ef;
      --light-red: #fbe9e7;
      --border-color: #dee2e6;
      --shadow: 0 4px 15px rgba(0, 0, 0, 0.1 );
    }

    body { 
      font-family: 'Cairo', sans-serif; 
      text-align: right; 
      background-color: var(--secondary-color); 
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    .container { 
      max-width: 800px; 
      width: 100%;
      background: var(--light-color); 
      padding: 30px; 
      border-radius: 12px; 
      box-shadow: var(--shadow);
      transition: all 0.3s ease-in-out;
    }

    .screen {
      display: none;
      animation: fadeIn 0.5s;
    }
    .screen.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h1, h2 { 
      color: var(--dark-color); 
      text-align: center;
      margin-bottom: 25px;
    }
    h1 { font-size: 2.2rem; }
    h2 { font-size: 1.8rem; }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 700;
      color: #555;
    }

    input[type="text"], input[type="number"] {
      width: 100%; 
      padding: 12px; 
      border-radius: 8px; 
      border: 1px solid var(--border-color);
      box-sizing: border-box;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
      outline: none;
    }

    button { 
      width: 100%;
      padding: 15px; 
      background: linear-gradient(45deg, var(--primary-color), #0056b3);
      color: var(--light-color); 
      font-size: 18px; 
      font-weight: 700;
      cursor: pointer; 
      border: none;
      border-radius: 8px;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }
    button:hover { 
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    button:disabled { 
      background: #ccc; 
      cursor: not-allowed; 
      transform: none;
      box-shadow: none;
    }

    .loader { 
      text-align: center; 
      font-size: 18px; 
      padding: 40px; 
      color: #777;
    }

    /* Quiz Screen Styles */
    #quiz-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    #timer {
      font-size: 1.2rem;
      font-weight: 700;
      background-color: #e9ecef;
      padding: 5px 15px;
      border-radius: 20px;
    }
    #progress-bar-container {
      width: 100%;
      background-color: #e9ecef;
      border-radius: 20px;
      margin-bottom: 20px;
    }
    #progress-bar {
      width: 0%;
      height: 15px;
      background: linear-gradient(45deg, var(--success-color), #218838);
      border-radius: 20px;
      transition: width 0.5s ease-in-out;
      text-align: center;
      color: white;
      font-size: 12px;
      line-height: 15px;
    }

    .question-container { 
      margin-bottom: 30px; 
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      background-color: #fdfdfd;
    }
    .question-container img { 
      width: 100%; 
      height: auto; 
      border-radius: 8px; 
      margin-bottom: 20px; 
    }
    .answer-field { 
      display: flex; 
      align-items: center; 
      margin-bottom: 10px; 
    }
    .answer-field span { 
      margin-left: 15px; 
      font-weight: bold; 
      font-size: 1.1rem;
      width: 30px;
      color: var(--primary-color);
    }

    /* Results Screen Styles */
    #score {
      text-align: center;
      font-size: 1.5rem;
      font-weight: 700;
      padding: 20px;
      border-radius: 8px;
      background-color: var(--secondary-color);
      margin-bottom: 25px;
    }
    .review-item {
      margin-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 15px;
    }
    .review-item:last-child {
      border-bottom: none;
    }
    .review-item h4 {
      margin-bottom: 10px;
    }
    .review-item p { 
      padding: 10px; 
      border-radius: 6px; 
      margin: 5px 0;
      display: flex;
      align-items: center;
    }
    .review-item .correct { 
      background-color: var(--light-green); 
      color: #155724;
    }
    .review-item .incorrect { 
      background-color: var(--light-red); 
      color: #721c24;
    }
    .review-item i {
      margin-left: 10px;
      font-size: 1.2rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- شاشة البداية -->
    <div id="start-screen" class="screen active">
      <h1><i class="fas fa-flask-vial"></i> اختبار رسومات العلوم</h1>
      <div id="loader" class="loader">
        <p>جاري تحميل بيانات الاختبار...</p>
        <i class="fas fa-spinner fa-spin fa-2x"></i>
      </div>
      <div id="setup-form" style="display:none;">
        <div class="form-group">
          <label for="userName">أدخل اسمك:</label>
          <input type="text" id="userName" placeholder="الاسم الكامل">
        </div>
        <div class="form-group">
          <label for="numQuestions">اختر عدد الرسومات (1-5):</label>
          <input type="number" id="numQuestions" min="1" max="5" value="3">
        </div>
        <button id="start-btn" onclick="startQuiz()"><i class="fas fa-play"></i> بدء الاختبار</button>
      </div>
    </div>

    <!-- شاشة الاختبار -->
    <div id="quiz-container" class="screen">
      <div id="quiz-header">
        <h2 id="welcome-msg"></h2>
        <div id="timer">00:00</div>
      </div>
      <div id="progress-bar-container">
        <div id="progress-bar"></div>
      </div>
      <div id="questions"></div>
      <button onclick="submitQuiz()"><i class="fas fa-check-double"></i> إنهاء وعرض النتيجة</button>
    </div>

    <!-- شاشة النتائج -->
    <div id="results-container" class="screen">
      <h2><i class="fas fa-poll"></i> النتائج النهائية</h2>
      <p id="score"></p>
      <div id="review"></div>
      <button onclick="location.reload()"><i class="fas fa-redo"></i> إعادة الاختبار</button>
    </div>
  </div>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vShYh1m_DNgpy4He1kT7j3yqoo1PzQImpzwiZzaz0NXJTqXM8hfbzGGfazYx9jKGdXIuNoXXzSwjIy4/pub?gid=158926968&single=true&output=csv";

    // Global variables
    let allQuestions = [], userAnswers = [], currentQuestions = [];
    let studentName = '', timerInterval;

    // DOM Elements
    const loader = document.getElementById('loader');
    const setupForm = document.getElementById('setup-form');
    const screens = {
      start: document.getElementById('start-screen'),
      quiz: document.getElementById('quiz-container'),
      results: document.getElementById('results-container')
    };

    // --- 1. Data Fetching and Initialization ---
    document.addEventListener('DOMContentLoaded', fetchData);

    async function fetchData() {
      try {
        const response = await fetch(CSV_URL);
        if (!response.ok) throw new Error('فشل تحميل البيانات. تأكد من صحة الرابط وأنه منشور بشكل صحيح.');
        const csvText = await response.text();
        allQuestions = parseCSV(csvText);
        
        loader.style.display = 'none';
        setupForm.style.display = 'block';
      } catch (error) {
        loader.innerHTML = `<p style="color: var(--danger-color);">خطأ: ${error.message}</p>`;
        console.error(error);
      }
    }

    function parseCSV(text) {
      const rows = text.split(/\r?\n/).slice(1);
      return rows.map(row => {
        const columns = row.split(',');
        if (columns.length < 7) return null;

        let imageUrl = columns[1].trim();
        if (imageUrl.includes('docs.google.com/drawings/d/')) {
          const match = imageUrl.match(/drawings\/d\/([a-zA-Z0-9_-]+)/);
          if (match && match[1]) {
            imageUrl = `https://docs.google.com/drawings/d/${match[1]}/export/png`;
          }
        }
        
        return {
          lesson: columns[0],
          imageUrl: imageUrl,
          answers: columns.slice(2, 7 ).map(ans => ans.trim())
        };
      }).filter(q => q && q.imageUrl);
    }

    // --- 2. Quiz Logic ---
    function startQuiz() {
      studentName = document.getElementById('userName').value;
      const numQuestions = parseInt(document.getElementById('numQuestions').value, 10);

      if (!studentName) { alert('الرجاء إدخال اسمك.'); return; }
      if (isNaN(numQuestions) || numQuestions < 1 || numQuestions > 5) { alert('الرجاء اختيار عدد رسمات بين 1 و 5.'); return; }
      if (allQuestions.length === 0) { alert('لا توجد أسئلة متاحة.'); return; }

      currentQuestions = shuffleArray(allQuestions).slice(0, Math.min(numQuestions, allQuestions.length));
      
      document.getElementById('welcome-msg').innerText = `بالتوفيق، ${studentName}!`;
      switchScreen('quiz');
      displayQuestions();
      startTimer();
    }

    function displayQuestions() {
      const questionsDiv = document.getElementById('questions');
      questionsDiv.innerHTML = '';
      userAnswers = [];

      currentQuestions.forEach((q, index) => {
        userAnswers.push(new Array(5).fill(''));
        let questionHTML = `<div class="question-container" id="q-container-${index}">
                              <h3>الرسمة ${index + 1}: ${q.lesson}</h3>
                              <img src="${q.imageUrl}" alt="رسمة ${q.lesson}" onerror="this.parentElement.innerHTML += '<p style=\'color:red;\'>خطأ في تحميل الصورة.</p>'; this.style.display='none';">`;
        for (let i = 0; i < 5; i++) {
          questionHTML += `<div class="answer-field">
                             <span>${i + 1}:</span>
                             <input type="text" oninput="updateAnswer(${index}, ${i}, this.value)" placeholder="اكتب المسمى هنا">
                           </div>`;
        }
        questionHTML += `</div>`;
        questionsDiv.innerHTML += questionHTML;
      });
    }
    
    function updateAnswer(qIndex, aIndex, value) {
      userAnswers[qIndex][aIndex] = value.trim();
      updateProgressBar();
    }

    function submitQuiz() {
      clearInterval(timerInterval);
      let score = 0;
      const totalLabels = currentQuestions.length * 5;
      const reviewDiv = document.getElementById('review');
      reviewDiv.innerHTML = '';

      currentQuestions.forEach((q, qIndex) => {
        let questionReview = `<div class="review-item"><h4>مراجعة الرسمة ${qIndex + 1} (${q.lesson})</h4>`;
        q.answers.forEach((correctAnswer, aIndex) => {
          const userAnswer = userAnswers[qIndex][aIndex] || "";
          if (userAnswer.toLowerCase() === correctAnswer.toLowerCase()) {
            score++;
            questionReview += `<p class="correct"><i class="fas fa-check-circle"></i><b>${aIndex + 1}:</b> إجابتك "${userAnswer}" (صحيحة)</p>`;
          } else {
            questionReview += `<p class="incorrect"><i class="fas fa-times-circle"></i><b>${aIndex + 1}:</b> إجابتك "${userAnswer}" (خطأ) - الإجابة الصحيحة: <b>${correctAnswer}</b></p>`;
          }
        });
        questionReview += `</div>`;
        reviewDiv.innerHTML += questionReview;
      });

      const percentage = totalLabels > 0 ? Math.round((score / totalLabels) * 100) : 0;
      document.getElementById('score').innerHTML = `يا ${studentName}، نتيجتك هي: <b>${score} من ${totalLabels}</b> (${percentage}%)`;
      switchScreen('results');
    }

    // --- 3. UI and Utility Functions ---
    function switchScreen(screenName) {
      for (let key in screens) {
        screens[key].classList.remove('active');
      }
      screens[screenName].classList.add('active');
    }

    function startTimer() {
      let seconds = 0;
      const timerEl = document.getElementById('timer');
      timerInterval = setInterval(() => {
        seconds++;
        const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
        const secs = (seconds % 60).toString().padStart(2, '0');
        timerEl.innerText = `${mins}:${secs}`;
      }, 1000);
    }

    function updateProgressBar() {
      const totalFields = currentQuestions.length * 5;
      const answeredFields = userAnswers.flat().filter(ans => ans !== "").length;
      const percentage = totalFields > 0 ? (answeredFields / totalFields) * 100 : 0;
      const progressBar = document.getElementById('progress-bar');
      progressBar.style.width = `${percentage}%`;
      progressBar.innerText = `${Math.round(percentage)}%`;
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }
  </script>
</body>
</html>
